This demo displays how Flink does its Anomaly detection using the ML_DETECT_ANOMALIES() function. It uses an ARIMA model to identify outliers. ARIMA is a common statistical model for time series forecasting.

The output is a time series chart flagging anomalies. The model is constantly retraining as it runs through new data. 

This demo can be customized by changing a few of the parameters and inputs. I recommend adding or removing outliers or changing the percentile in the ML_DETECT_ANOMALIES() function. What can be customized can be seen in the documentation linked above. 


1. Create the table where our time series will be stored. In here we are entering the timestamp and values. We use engine temperatures but it can be anything. 


```
CREATE TABLE temp (
  times TIMESTAMP(3),
  temp INT,
  WATERMARK FOR times AS times
);
```

2. Input the time series values into our table. These would normally be streaming values and inference with the ARIMA model would be done in real time. For demo simplicity we manually enter them:
   
```
INSERT INTO temp (times, temp) VALUES 
(CAST('2025-11-12 12:26:50.221' AS TIMESTAMP(3)), 193),
(CAST('2025-11-12 12:26:49.256' AS TIMESTAMP(3)), 182),
(CAST('2025-11-12 12:26:48.359' AS TIMESTAMP(3)), 188),
(CAST('2025-11-12 12:26:47.853' AS TIMESTAMP(3)), 229),
(CAST('2025-11-12 12:26:47.272' AS TIMESTAMP(3)), 180),
(CAST('2025-11-12 12:26:47.107' AS TIMESTAMP(3)), 202),
(CAST('2025-11-12 12:26:46.503' AS TIMESTAMP(3)), 193),
(CAST('2025-11-12 12:26:45.912' AS TIMESTAMP(3)), 247),
(CAST('2025-11-12 12:26:44.995' AS TIMESTAMP(3)), 201),
(CAST('2025-11-12 12:26:44.792' AS TIMESTAMP(3)), 178),
(CAST('2025-11-12 12:26:44.089' AS TIMESTAMP(3)), 177),
(CAST('2025-11-12 12:26:43.864' AS TIMESTAMP(3)), 237),
(CAST('2025-11-12 12:26:43.014' AS TIMESTAMP(3)), 164),
(CAST('2025-11-12 12:26:42.148' AS TIMESTAMP(3)), 182),
(CAST('2025-11-12 12:26:41.848' AS TIMESTAMP(3)), 244),
(CAST('2025-11-12 12:26:41.508' AS TIMESTAMP(3)), 227),
(CAST('2025-11-12 12:26:41.215' AS TIMESTAMP(3)), 200),
(CAST('2025-11-12 12:26:40.217' AS TIMESTAMP(3)), 210),
(CAST('2025-11-12 12:26:40.196' AS TIMESTAMP(3)), 168),
(CAST('2025-11-12 12:26:39.915' AS TIMESTAMP(3)), 242),
(CAST('2025-11-12 12:26:39.704' AS TIMESTAMP(3)), 246),
(CAST('2025-11-12 12:26:39.056' AS TIMESTAMP(3)), 243),
(CAST('2025-11-12 12:26:38.536' AS TIMESTAMP(3)), 222),
(CAST('2025-11-12 12:26:38.226' AS TIMESTAMP(3)), 204),
(CAST('2025-11-12 12:26:37.522' AS TIMESTAMP(3)), 205),
(CAST('2025-11-12 12:26:37.446' AS TIMESTAMP(3)), 199),
(CAST('2025-11-12 12:26:36.449' AS TIMESTAMP(3)), 157),
(CAST('2025-11-12 12:26:35.898' AS TIMESTAMP(3)), 245),
(CAST('2025-11-12 12:26:35.286' AS TIMESTAMP(3)), 240),
(CAST('2025-11-12 12:26:35.232' AS TIMESTAMP(3)), 198),
(CAST('2025-11-12 12:26:34.784' AS TIMESTAMP(3)), 202),
(CAST('2025-11-12 12:26:34.781' AS TIMESTAMP(3)), 150),
(CAST('2025-11-12 12:26:34.502' AS TIMESTAMP(3)), 181),
(CAST('2025-11-12 12:26:34.501' AS TIMESTAMP(3)), 153),
(CAST('2025-11-12 12:26:34.033' AS TIMESTAMP(3)), 174),
(CAST('2025-11-12 12:26:33.678' AS TIMESTAMP(3)), 228),
(CAST('2025-11-12 12:26:32.782' AS TIMESTAMP(3)), 190),
(CAST('2025-11-12 12:26:32.498' AS TIMESTAMP(3)), 183),
(CAST('2025-11-12 12:26:31.926' AS TIMESTAMP(3)), 228),
(CAST('2025-11-12 12:26:31.508' AS TIMESTAMP(3)), 171),
(CAST('2025-11-12 12:26:30.724' AS TIMESTAMP(3)), 236),
(CAST('2025-11-12 12:26:30.205' AS TIMESTAMP(3)), 234),
(CAST('2025-11-12 12:26:29.746' AS TIMESTAMP(3)), 158),
(CAST('2025-11-12 12:26:29.267' AS TIMESTAMP(3)), 186),
(CAST('2025-11-12 12:26:28.480' AS TIMESTAMP(3)), 164),
(CAST('2025-11-12 12:26:27.955' AS TIMESTAMP(3)), 211),
(CAST('2025-11-12 12:26:26.880' AS TIMESTAMP(3)), 198),
(CAST('2025-11-12 12:26:26.647' AS TIMESTAMP(3)), 185),
(CAST('2025-11-12 12:26:25.706' AS TIMESTAMP(3)), 184),
(CAST('2025-11-12 12:26:24.792' AS TIMESTAMP(3)), 155),
(CAST('2025-11-12 12:26:24.428' AS TIMESTAMP(3)), 216),
(CAST('2025-11-12 12:26:23.888' AS TIMESTAMP(3)), 228),
(CAST('2025-11-12 12:26:23.608' AS TIMESTAMP(3)), 244),
(CAST('2025-11-12 12:26:23.518' AS TIMESTAMP(3)), 182),
(CAST('2025-11-12 12:26:23.079' AS TIMESTAMP(3)), 153),
(CAST('2025-11-12 12:26:22.540' AS TIMESTAMP(3)), 218),
(CAST('2025-11-12 12:26:21.544' AS TIMESTAMP(3)), 201),
(CAST('2025-11-12 12:26:20.655' AS TIMESTAMP(3)), 193),
(CAST('2025-11-12 12:26:19.960' AS TIMESTAMP(3)), 202),
(CAST('2025-11-12 12:26:19.885' AS TIMESTAMP(3)), 207),
(CAST('2025-11-12 12:26:19.318' AS TIMESTAMP(3)), 226),
(CAST('2025-11-12 12:26:18.485' AS TIMESTAMP(3)), 191),
(CAST('2025-11-12 12:26:18.288' AS TIMESTAMP(3)), 216),
(CAST('2025-11-12 12:26:18.113' AS TIMESTAMP(3)), 185),
(CAST('2025-11-12 12:26:17.966' AS TIMESTAMP(3)), 185),
(CAST('2025-11-12 12:26:17.754' AS TIMESTAMP(3)), 151),
(CAST('2025-11-12 12:26:17.556' AS TIMESTAMP(3)), 235),
(CAST('2025-11-12 12:26:16.709' AS TIMESTAMP(3)), 211),
(CAST('2025-11-12 12:26:16.688' AS TIMESTAMP(3)), 201),
(CAST('2025-11-12 12:26:15.984' AS TIMESTAMP(3)), 192),
(CAST('2025-11-12 12:26:15.140' AS TIMESTAMP(3)), 175),
(CAST('2025-11-12 12:26:14.390' AS TIMESTAMP(3)), 214),
(CAST('2025-11-12 12:26:13.732' AS TIMESTAMP(3)), 217),
(CAST('2025-11-12 12:26:12.934' AS TIMESTAMP(3)), 218),
(CAST('2025-11-12 12:26:12.043' AS TIMESTAMP(3)), 240),
(CAST('2025-11-12 12:26:11.564' AS TIMESTAMP(3)), 227),
(CAST('2025-11-12 12:26:10.738' AS TIMESTAMP(3)), 226),
(CAST('2025-11-12 12:26:10.410' AS TIMESTAMP(3)), 232),
(CAST('2025-11-12 12:26:10.373' AS TIMESTAMP(3)), 215),
(CAST('2025-11-12 12:26:10.199' AS TIMESTAMP(3)), 163),
(CAST('2025-11-12 12:26:09.307' AS TIMESTAMP(3)), 179),
(CAST('2025-11-12 12:26:08.681' AS TIMESTAMP(3)), 201),
(CAST('2025-11-12 12:26:08.436' AS TIMESTAMP(3)), 242),
(CAST('2025-11-12 12:26:08.429' AS TIMESTAMP(3)), 229),
(CAST('2025-11-12 12:26:07.575' AS TIMESTAMP(3)), 229),
(CAST('2025-11-12 12:26:07.533' AS TIMESTAMP(3)), 248),
(CAST('2025-11-12 12:26:07.009' AS TIMESTAMP(3)), 177),
(CAST('2025-11-12 12:26:06.357' AS TIMESTAMP(3)), 167),
(CAST('2025-11-12 12:26:05.950' AS TIMESTAMP(3)), 169),
(CAST('2025-11-12 12:26:05.274' AS TIMESTAMP(3)), 178),
(CAST('2025-11-12 12:26:04.408' AS TIMESTAMP(3)), 238),
(CAST('2025-11-12 12:26:03.497' AS TIMESTAMP(3)), 191),
(CAST('2025-11-12 12:26:03.186' AS TIMESTAMP(3)), 231),
(CAST('2025-11-12 12:26:02.456' AS TIMESTAMP(3)), 162),
(CAST('2025-11-12 12:26:02.105' AS TIMESTAMP(3)), 182),
(CAST('2025-11-12 12:26:01.872' AS TIMESTAMP(3)), 216),
(CAST('2025-11-12 12:26:01.596' AS TIMESTAMP(3)), 170),
(CAST('2025-11-12 12:26:00.607' AS TIMESTAMP(3)), 155),
(CAST('2025-11-12 12:25:59.732' AS TIMESTAMP(3)), 197),
(CAST('2025-11-12 12:25:59.429' AS TIMESTAMP(3)), 221),
(CAST('2025-11-12 12:25:59.339' AS TIMESTAMP(3)), 168),
(CAST('2025-11-12 12:25:59.062' AS TIMESTAMP(3)), 209),
(CAST('2025-11-12 12:25:58.435' AS TIMESTAMP(3)), 163),
(CAST('2025-11-12 12:25:57.974' AS TIMESTAMP(3)), 152),
(CAST('2025-11-12 12:25:57.369' AS TIMESTAMP(3)), 163),
(CAST('2025-11-12 12:25:57.284' AS TIMESTAMP(3)), 152),
(CAST('2025-11-12 12:25:56.827' AS TIMESTAMP(3)), 204),
(CAST('2025-11-12 12:25:56.575' AS TIMESTAMP(3)), 239),
(CAST('2025-11-12 12:25:56.068' AS TIMESTAMP(3)), 189),
(CAST('2025-11-12 12:25:56.032' AS TIMESTAMP(3)), 154),
(CAST('2025-11-12 12:25:55.630' AS TIMESTAMP(3)), 201),
(CAST('2025-11-12 12:25:55.117' AS TIMESTAMP(3)), 190),
(CAST('2025-11-12 12:25:54.203' AS TIMESTAMP(3)), 192),
(CAST('2025-11-12 12:25:53.859' AS TIMESTAMP(3)), 212),
(CAST('2025-11-12 12:25:53.515' AS TIMESTAMP(3)), 206),
(CAST('2025-11-12 12:25:53.400' AS TIMESTAMP(3)), 158),
(CAST('2025-11-12 12:25:52.857' AS TIMESTAMP(3)), 235),
(CAST('2025-11-12 12:25:52.543' AS TIMESTAMP(3)), 219),
(CAST('2025-11-12 12:25:52.124' AS TIMESTAMP(3)), 167),
(CAST('2025-11-12 12:25:51.855' AS TIMESTAMP(3)), 177),
(CAST('2025-11-12 12:25:51.018' AS TIMESTAMP(3)), 178),
(CAST('2025-11-12 12:25:50.124' AS TIMESTAMP(3)), 241),
(CAST('2025-11-12 12:25:49.877' AS TIMESTAMP(3)), 220),
(CAST('2025-11-12 12:25:49.461' AS TIMESTAMP(3)), 209),
(CAST('2025-11-12 12:25:48.871' AS TIMESTAMP(3)), 242),
(CAST('2025-11-12 12:25:48.039' AS TIMESTAMP(3)), 163),
(CAST('2025-11-12 12:25:47.712' AS TIMESTAMP(3)), 187),
(CAST('2025-11-12 12:25:47.589' AS TIMESTAMP(3)), 161),
(CAST('2025-11-12 12:25:46.638' AS TIMESTAMP(3)), 160),
(CAST('2025-11-12 12:25:45.792' AS TIMESTAMP(3)), 216),
(CAST('2025-11-12 12:25:45.299' AS TIMESTAMP(3)), 201),
(CAST('2025-11-12 12:25:44.535' AS TIMESTAMP(3)), 197),
(CAST('2025-11-12 12:25:43.540' AS TIMESTAMP(3)), 166),
(CAST('2025-11-12 12:25:43.380' AS TIMESTAMP(3)), 218),
(CAST('2025-11-12 12:25:43.023' AS TIMESTAMP(3)), 160),
(CAST('2025-11-12 12:25:42.767' AS TIMESTAMP(3)), 237),
(CAST('2025-11-12 12:25:42.376' AS TIMESTAMP(3)), 187),
(CAST('2025-11-12 12:25:41.927' AS TIMESTAMP(3)), 246),
(CAST('2025-11-12 12:25:41.820' AS TIMESTAMP(3)), 203),
(CAST('2025-11-12 12:25:41.752' AS TIMESTAMP(3)), 171),
(CAST('2025-11-12 12:25:40.791' AS TIMESTAMP(3)), 213),
(CAST('2025-11-12 12:25:39.989' AS TIMESTAMP(3)), 247),
(CAST('2025-11-12 12:25:39.682' AS TIMESTAMP(3)), 228),
(CAST('2025-11-12 12:25:39.447' AS TIMESTAMP(3)), 173),
(CAST('2025-11-12 12:25:39.152' AS TIMESTAMP(3)), 239),
(CAST('2025-11-12 12:25:38.648' AS TIMESTAMP(3)), 239),
(CAST('2025-11-12 12:25:37.847' AS TIMESTAMP(3)), 178),
(CAST('2025-11-12 12:25:37.398' AS TIMESTAMP(3)), 235);
```

3. Create a query to view the output. TUMBLE() along creates time windows of 0.01 seconds and averages all of the values that occurred in that period.  

```
WITH windowed_avg AS (
    SELECT
        window_start,
        window_end,
        window_time,
        AVG(temp) AS avg_temps
    FROM TABLE(
         TUMBLE(TABLE temp, DESCRIPTOR(times), INTERVAL '0.01' SECONDS)
    )
    GROUP BY window_start, window_end, window_time
)
SELECT
    window_start,
    avg_temps,
    ML_DETECT_ANOMALIES(avg_temps, window_time, JSON_OBJECT('confidencePercentage' VALUE 96.0, 'p' VALUE 1, 'q' VALUE 1, 'd' VALUE 1, 'minTrainingSize' VALUE 50))
        OVER (
            ORDER BY window_time
            RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW
        ) AS anomaly
FROM windowed_avg;
```

Resources: 

https://docs.confluent.io/cloud/current/ai/builtin-functions/detect-anomalies.html
